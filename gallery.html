<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery - Saadat Notes</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Page-specific styles for Gallery elements -->
    <style>
        .work-card { border:1px solid var(--border-color); border-radius:12px; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; background:var(--bg-secondary); }
        .work-card-content { padding: 1.5rem; flex-grow: 1; }
        .work-card-content h3 { font-family: var(--bangla-font); font-size: 1.5rem; margin-bottom: 0.5rem; }
        .work-card-content p { font-family: var(--bangla-font); white-space: pre-wrap; }
        .work-card-footer { background-color: var(--bg-tertiary); padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); display:flex; justify-content:space-between; align-items:center; font-size: 0.9rem; }
        .slideshow-container img { width: 100%; height: 100%; object-fit: cover; position: absolute; top:0; left:0; opacity: 0; transition: opacity 0.8s ease-in-out; }
        .slideshow-container img.active { opacity: 1; }
        .slide-caption-text { text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="header-content">
            <a href="index.html" class="logo-area"><img src="https://i.ibb.co/68c1mP7/Saadat-Notes-Logo.png" alt="Logo"><div class="logo-text"><h1>Saadat Notes</h1><p>For Dept. of Mathematics (2023-2024)</p></div></a>
            <button class="hamburger-menu" id="hamburger-menu-btn" aria-label="Open menu"><svg class="icon" width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3 12H21" stroke-width="2.5" stroke="currentColor" stroke-linecap="round"/><path d="M3 6H21" stroke-width="2.5" stroke="currentColor" stroke-linecap="round"/><path d="M3 18H21" stroke-width="2.5" stroke="currentColor" stroke-linecap="round"/></svg></button>
        </div>
    </header>

    <div class="mobile-nav-panel" id="mobile-nav">
        <button class="close-nav" id="close-nav-btn" aria-label="Close menu">&times;</button>
        <nav><ul><li><a href="index.html">Dashboard</a></li><li><a href="notes.html">Hand Notes</a></li><li><a href="gallery.html">Gallery</a></li><li><a href="contact.html">Contact Us</a></li></ul></nav>
    </div>
    
    <!-- This is the container for the entire gallery app -->
    <div id="saadat-gallery-widget">
        <main class="page-container">
            <div id="sgw-admin-panel"></div> <!-- Admin Panel UI will be injected here -->
            
            <header class="gallery-header"><h1>Gallery</h1><div id="sgw-admin-controls" class="admin-controls"></div></header>

            <nav class="tab-nav">
                <button class="tab-button active" data-action="tab" data-tab="sgw-campus-gallery">Campus Life</button>
                <button class="tab-button" data-action="tab" data-tab="sgw-student-gallery">Student Corner</button>
            </nav>

            <section id="sgw-campus-gallery" class="tab-content active"><p style="text-align:center;">Loading Gallery...</p></section>
            <section id="sgw-student-gallery" class="tab-content"><p style="text-align:center;">Loading Student Works...</p></section>
        </main>
        
        <div class="modal-overlay" id="sgw-modal-container"></div>
    </div>
    
    <footer class="site-footer"><p>Â© 2024 Saadat Notes. All rights reserved.</p></footer>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            (function initializeGalleryApp() {
                const widgetRoot = document.getElementById('saadat-gallery-widget');
                if (!widgetRoot) return;

                const firebaseConfig = {
                    apiKey: "AIzaSyBtCSFfTvu1peSJvU2mt2di29C4dlCRmLA",
                    authDomain: "notebook-021.firebaseapp.com",
                    projectId: "notebook-021",
                    storageBucket: "notebook-021.appspot.com",
                    messagingSenderId: "698880291664",
                    appId: "1:698880291664:web:2df8500cc801fb856c3255",
                    measurementId: "G-TSYHPTNMME"
                };

                if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
                const db = firebase.firestore();
                const auth = firebase.auth();
                let latestPhotos = [], latestWorks = [], slideshowInterval = null;

                // --- PUBLIC RENDER FUNCTIONS ---
                function renderCampusGallery(photos) {
                    const container = widgetRoot.querySelector('#sgw-campus-gallery');
                    if (!container) return;
                    container.innerHTML = photos.length > 0 ?
                        `<div class="slideshow-container"><div id="sgw-slides-wrapper">${photos.map((p, i) => `<img src="${p.url}" alt="${p.caption}" class="${i === 0 ? 'active' : ''}">`).join('')}</div>
                        <div class="slide-caption-container"><span id="slide-caption-text"></span><div id="slide-caption-admin-controls"></div></div></div>`
                        : `<p style="text-align:center;">No campus photos yet.</p>`;
                    if (photos.length > 0) setupSlideshow(photos);
                }

                function renderStudentWorks(works) {
                    const container = widgetRoot.querySelector('#sgw-student-gallery');
                    if (!container) return;
                    const isAdmin = !!auth.currentUser;
                    container.innerHTML = works.length > 0 ? `<div class="student-works-grid">${works.map(w => `<div class="work-card">
                        <div class="work-card-content"><h3>${w.title}</h3><p>${w.content}</p></div>
                        <div class="work-card-footer"><span>${w.author} - ${w.year}</span>
                        ${isAdmin ? `<button class="action-button delete-button" data-action="delete" data-collection="studentWorks" data-id="${w.id}">Delete</button>` : ''}</div>
                    </div>`).join('')}</div>` : `<p style="text-align:center;">No student works yet.</p>`;
                }

                function setupSlideshow(photos) {
                    clearInterval(slideshowInterval);
                    let current = 0;
                    const slides = widgetRoot.querySelectorAll('.slideshow-container img'), captionText = widgetRoot.querySelector('#slide-caption-text'), captionAdmin = widgetRoot.querySelector('#slide-caption-admin-controls'), container = widgetRoot.querySelector('.slideshow-container');
                    if (!slides.length || !container) return;
                    
                    const showSlide = (index) => {
                        const photo = photos[index];
                        if (!photo) return;
                        slides.forEach(s => s.classList.remove('active'));
                        slides[index].classList.add('active');
                        captionText.textContent = photo.caption;
                        captionAdmin.innerHTML = auth.currentUser ? `<button class="action-button delete-button" data-action="delete" data-collection="galleryPhotos" data-id="${photo.id}">Delete</button>` : '';
                        current = index;
                    };
                    const nextSlide = () => showSlide((current + 1) % slides.length);
                    const startAutoplay = () => { if (photos.length > 1) { slideshowInterval = setInterval(nextSlide, 5000); }};
                    
                    container.onmouseenter = () => clearInterval(slideshowInterval);
                    container.onmouseleave = startAutoplay;
                    showSlide(0);
                    startAutoplay();
                }

                // --- DATA & AUTH LISTENERS ---
                db.collection("galleryPhotos").orderBy("createdAt", "desc").onSnapshot(s => { latestPhotos = s.docs.map(d=>({id:d.id,...d.data()})); renderCampusGallery(latestPhotos); });
                db.collection("studentWorks").orderBy("createdAt", "desc").onSnapshot(s => { latestWorks = s.docs.map(d=>({id:d.id,...d.data()})); renderStudentWorks(latestWorks); });
                
                auth.onAuthStateChanged(user => {
                    widgetRoot.querySelector('#sgw-admin-controls').innerHTML = user ? `<button class="admin-button" data-action="open-admin-panel">Admin Panel</button><button class="admin-button" data-action="logout">Logout</button>` : `<button class="admin-button" data-action="login">Admin Login</button>`;
                    renderCampusGallery(latestPhotos); renderStudentWorks(latestWorks);
                });

                // --- GLOBAL EVENT DELEGATION ---
                widgetRoot.addEventListener('click', e => {
                    const target = e.target.closest('[data-action]');
                    if (!target) return;
                    const { action, id, collection, tab } = target.dataset;

                    switch (action) {
                        case 'login': showModal('login'); break;
                        case 'logout': auth.signOut(); break;
                        case 'open-admin-panel': showAdminPanel(); break;
                        case 'close-admin-panel': widgetRoot.querySelector('#sgw-admin-panel').classList.remove('active'); break;
                        case 'add-new': showModal('add'); break;
                        case 'edit':
                            const data = (collection === 'galleryPhotos' ? latestPhotos : latestWorks).find(item => item.id === id);
                            if (data) showModal('edit', { ...data, collection });
                            break;
                        case 'delete':
                            if (confirm("Permanently delete this item?")) {
                                db.collection(collection).doc(id).delete().catch(err => alert("Error: " + err.message));
                            }
                            break;
                        case 'tab':
                            const scope = target.closest('#sgw-admin-panel') || widgetRoot;
                            scope.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                            target.classList.add('active');
                            scope.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.id === tab));
                            break;
                    }
                });

                // --- ADMIN PANEL & MODALS ---
                function showAdminPanel() {
                    const panel = widgetRoot.querySelector('#sgw-admin-panel');
                    panel.innerHTML = `
                        <header class="admin-header"><h2>Admin Dashboard</h2><div><button class="primary-button" data-action="add-new">Add New Content</button><button data-action="close-admin-panel" class="close-nav">&times;</button></div></header>
                        <main class="admin-main">
                            <nav class="tab-nav"><button class="tab-button active" data-action="tab" data-tab="admin-photos">Manage Photos</button><button class="tab-button" data-action="tab" data-tab="admin-works">Manage Works</button></nav>
                            <section id="admin-photos" class="tab-content active"></section><section id="admin-works" class="tab-content"></section>
                        </main>`;
                    renderAdminLists(); panel.classList.add('active');
                }

                function renderAdminLists() {
                    const photosEl = widgetRoot.querySelector('#admin-photos'), worksEl = widgetRoot.querySelector('#admin-works');
                    if (!photosEl || !worksEl) return;
                    photosEl.innerHTML = `<div class="admin-content-list">${latestPhotos.map(p => `<div class="admin-list-item"><span class="admin-list-item-title">${p.caption}</span><div class="admin-item-controls"><button class="action-button edit-button" data-action="edit" data-collection="galleryPhotos" data-id="${p.id}">Edit</button><button class="action-button delete-button" data-action="delete" data-collection="galleryPhotos" data-id="${p.id}">Delete</button></div></div>`).join('') || `<p>No photos uploaded.</p>`}</div>`;
                    worksEl.innerHTML = `<div class="admin-content-list">${latestWorks.map(w => `<div class="admin-list-item"><span class="admin-list-item-title">${w.title}</span><div class="admin-item-controls"><button class="action-button edit-button" data-action="edit" data-collection="studentWorks" data-id="${w.id}">Edit</button><button class="action-button delete-button" data-action="delete" data-collection="studentWorks" data-id="${w.id}">Delete</button></div></div>`).join('') || `<p>No student works submitted.</p>`}</div>`;
                }
                
                function showModal(mode, data = {}) {
                    // Modal creation and form submission logic... [REMAINS LARGELY UNCHANGED FROM PREVIOUS WORKING VERSION]
                    // ... [Same logic as before] ...
                }
                // ... The rest of your JavaScript logic will go here
            })();
        });
    </script>

</body>
</html>